<!DOCTYPE html>
<!-- home for all of the functions that the app has available-->
	<head>
		<link rel="stylesheet" type="text/css" href="css/home.css">
		<script src="//www.parsecdn.com/js/parse-1.3.4.min.js"></script>
		<script type="text/javascript">Parse.initialize("1nbCZcm4WHUpYs0C89oTo231mhcpL2LRa5KfsYtw", "nNWuXfGI2ujbWBzxd5Om3F3OgFIIZRfvonOxfdEc");</script>
	</head>
	<body style="background-color:#0072ff">
		<div class="content">
			<div class="spacerT"><img src = "img/notifications.png" onclick="notify()" id = "notifImage"></div>
			<div class = "spacerB"> </div>
			<div class = "spacerL"> </div>
			<div class = "spacerR"> </div>
			<div class = "LeftImage">
				<a href = "score.html"> <img src = "img/Score.png" id = "Image" ></a>
				<a href = "store.html"><img src = "img/Store.png" id = "Image"></a>
				<a href = "club.html"><img src = "img/Clubs.png" id = "Image"></a>
			</div>
			<div class = "RightImage">
				<a href = "lunches.html"><img src = "img/Sandwich.png" id = "Image"></a>
				<a href = "news.html"><img src = "img/news.png" id = "Image"></a>
				<a href = "map.html"><img src = "img/map.png" id = "Image"></a>
			</div>
		</div>
		
		<script type="text/javascript">
			//Store the database stuff
			var alertObjects = [];
			
			//gets image to replace
			var bell = document.getElementById("notifImage");
			
			//checks to see if notification was viewed already
			var viewed = false;
			var lastNotif = 0;

			//Connect to database class
			var alerts = Parse.Object.extend("SchoolAlert");
			var query = new Parse.Query(alerts);
			
			//Allows up to 1000 objects to be received from the database, up from the default 100
			query.limit(1000);
			//Returns all objects in an array
			query.find({
				success: function(results) 
				{
					console.log("searching parse");
					lengthOfResults = results.length;
					for(var i = 0; i < results.length; i++) 
					{
						//Transfer results to earlier array
						alertObjects.push(results[i]);
					}
					//gets num of notifications since last time homepage was used
					lastNotif = window.localStorage.getItem("lastNotif");
					console.log(lastNotif);
					//if there are more notifications than last time, the notifications should be viewed
					if(lastNotif < alertObjects.length)
					{
						console.log("more notifications!");
						window.localStorage.setItem("viewed", false);
						window.localStorage.setItem("lastNotif", alertObjects.length);
						viewed = false;
					}
					//otherwise, status of whether or not they should be viewed stays the same
					else
						viewed = window.localStorage.getItem("viewed");
					
					//then, done is called to ring bell if necessary
					console.log(viewed);
					done();
				},
				error: function(error) 
				{
					alert(error);
				}
			});
			
			//function to make sure data is collected before this if statement
			function done()
			{
				console.log("entered done");
				if(alertObjects.length > 0)
				{
					console.log("objects to show" + viewed);
					if(!viewed || viewed == "false")
					{
						console.log("in done"+viewed);
						ringBell();
					}
					else
						bell.src = "img/notificationPresent.png";

				}
			}
			
			//function that moves to notify from home page and makes necessary changes beforehand
			function notify()
			{
				console.log("viewed:" + viewed + " last notif:" + lastNotif);
				var alerts = [];
				
				//make an array to send
				for(var i = 0; i < alertObjects.length; i++)
				{
					var temp = [2];
					temp[0] = alertObjects[i].get("Event");
					temp[1] = alertObjects[i].get("willOccurOn");
					alerts.push(temp);
				}
				//send all the stuff
				window.localStorage.setItem("viewed", true);
				window.localStorage.setItem("lastNotif", alertObjects.length);
				window.localStorage.setItem("notifications", JSON.stringify(alerts));
				window.location = "notif.html";
			}
			
			//will make the notification icon look like it is ringing and show that there is a new notification
			function ringBell()
			{
				//to count the images and how many times to "ring" the bell
				var count = 0;
				var innerCount = 0;
				
				//runs switch image once every half second.
				var timer = setInterval(function() 
				{
					if(count < 2)
					{
						switchImage(innerCount);
					}
					
					else
					{
						bell.src="img/notificationPresent.png";
					}
					
				}, 150);
				
				function switchImage(num)
				{
					switch(num)
					{
						case 0:
							bell.src="img/notification1.png";
							innerCount++;
							break;
						case 1:
							bell.src="img/notification2.png";
							innerCount++;
							break;
						case 2:
							bell.src="img/notification1.png";
							innerCount++;
							break;
						case 3:
							bell.src="img/notifications.png";
							innerCount++;
							break;
						case 4:
							bell.src="img/notification3.png";
							innerCount++;
							break;
						case 5:
							bell.src="img/notification4.png";
							innerCount++;
							break;
						case 6:
							bell.src="img/notification3.png";
							innerCount++;
							break;
						case 7:
							bell.src="img/notifications.png";
							innerCount = 0;
							count++;
							break;
					}
				}
			}
		</script>
	</body>

</html>