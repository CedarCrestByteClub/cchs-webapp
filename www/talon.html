<!DOCTYPE html>
<html>
	<head>
		<title>Talon Page</title>
		<link rel="stylesheet" type="text/css" href="css/home.css">
		<script src="//www.parsecdn.com/js/parse-1.3.4.min.js"></script>
		<script type="text/javascript">Parse.initialize("1nbCZcm4WHUpYs0C89oTo231mhcpL2LRa5KfsYtw", "nNWuXfGI2ujbWBzxd5Om3F3OgFIIZRfvonOxfdEc");</script>
	</head>
	
	<body>
		
		<div style = "text-align: left; background-color:#00A2E8; ">
   			<input type="button" style="width:60px;height:40px;" onclick="toHome()" value="Back">
   		</div>
		
		<table id="linkTable">
		</table>
		
		<script type="text/javascript">
			var frameShowing = false;
			var numIssuesLoaded = 5;
			var TalonObjects = [];
			var TalonLinks = Parse.Object.extend("TalonLinks");
			var query = new Parse.Query(TalonLinks);
			query.limit(1000);
			query.find({
				success: function(results) {
					for(var i = 0; i < results.length; i++) {
						//alert(results[i].get("Issue"));
						TalonObjects.push(results[i]);
					}
				},
				error: function(error) {
					alert(error);
				}
			});
			//loads the talon issues
			interval = setInterval(function() 
			{
				//alert(TalonObjects.length);
				if(TalonObjects.length >= 170) 
				{
					//sorts issues and creats table that will display issues
					TalonObjects = sortArray(TalonObjects);
					loadList(numIssuesLoaded-5);
					stopInterval();
				}
			}, 250);
			function stopInterval() 
			{
				clearInterval(interval);
			}
			function loadView(id, TalonObjects) 
			{
				frameShowing = true;
				var issueNum = id.substring(id.length - 1);
				var url = TalonObjects[issueNum].get("Link");
				var body = document.getElementsByTagName("body")[0];
				var frame = document.createElement("iframe");
				frame.setAttribute("id", "frame");
				for(var i = 0; i < numIssuesLoaded; i++) {
					var cell = document.getElementById("cell" + i.toString());
					cell.parentNode.removeChild(cell);
				}
				var loadMore = document.getElementById("loadMore");
				loadMore.parentNode.removeChild(loadMore);
				frame.style.width = "100%";
				frame.style.height = "750px";
				frame.setAttribute("src", url);
				frame.style.visibility = "visible";
				body.appendChild(frame);
			}
			//this is bublle sort, very ineffective, should reconstruct
			function sortArray(array) 
			{
				while(isSorted(array) == false) 
				{
					for(var i = 1; i < array.length; i++) 
					{
						if(!(array[i].get("Year") < array[i-1].get("Year") || (array[i].get("Year") == array[i-1].get("Year") && array[i].get("Issue") < array[i-1].get("Issue"))))
						{
							var temp = array[i-1];
							array[i-1] = array[i];
							array[i] = temp;
						}
					}
				}
				return array;
			}
			function isSorted(array) 
			{
				for(var i = 1; i < array.length; i++) 
				{
					if(!(array[i].get("Year") < array[i-1].get("Year") || (array[i].get("Year") == array[i-1].get("Year") && array[i].get("Issue") < array[i-1].get("Issue"))))
					{
						return false;
					}
				}
				return true;
			}
			function addMore() {
				numIssuesLoaded += 5;
				var button = document.getElementById("loadMore");
				button.parentNode.removeChild(button);
				loadList(numIssuesLoaded-5);
			}
			function loadList(start) {
				var table = document.getElementById("linkTable");
				//adds all of the issues to the table and a button to view the issues
				for(var i = start; i < numIssuesLoaded; i++) 
				{
					var row = table.insertRow(table.rows.length);
					var cell = row.insertCell(0);
					cell.setAttribute("id", "cell" + i.toString());
					//alert(TalonObjects[i]);
					var text1 = document.createTextNode("Issue " + (TalonObjects[i].get("Issue")).toString());
					var text2 = document.createTextNode("\n" + (TalonObjects[i].get("Year")).toString() + "-" + (TalonObjects[i].get("Year") + 1).toString() + " School Year\n");
					cell.appendChild(text1);
					cell.appendChild(text2);
					var button = document.createElement("input");
					button.setAttribute("value", "View");
					button.setAttribute("type", "button");
					button.setAttribute("onclick", "loadView(this.id, TalonObjects)");
					button.setAttribute("id", "issueButton" + i.toString());
					console.log(i.toString());
					cell.appendChild(button);
				}
				//adds a button to load more issues
				var row = table.insertRow(table.rows.length);
				var cell = row.insertCell(0);
				var button = document.createElement("input");
				button.setAttribute("value", "More");
				button.setAttribute("type", "button");
				button.setAttribute("id", "loadMore");
				button.setAttribute("onclick", "addMore()");
				cell.appendChild(button);
			}
			function toHome()
			{
				if(frameShowing) {
					var frame = document.getElementById("frame");
					frame.parentNode.removeChild(frame);
					loadList(0);
					frameShowing = false;
				} else {
					window.location = "home.html";
				}
			}
		</script>
		
	</body>
</html>